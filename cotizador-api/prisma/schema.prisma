generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

// ===============================
// USERS & COMPANIES
// ===============================

model User {
  id             String        @id @default(uuid()) @db.VarChar(36)
  email          String        @unique @db.VarChar(255)
  password       String        @db.VarChar(255)
  firstName      String        @db.VarChar(100)
  lastName       String        @db.VarChar(100)
  role           Role          @default(USER)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relación con compañías
  companies      UserCompany[]

  // Planes creados
  createdPlans   Plan[]        @relation("CreatedPlans")

  quotations     Quotation[]
 
  createdPlanVersions PlanVersion[] @relation("CreatedPlanVersions")
  @@map("users") 
}

model Company {
  id          String        @id @default(uuid()) @db.VarChar(36)
  name        String        @db.VarChar(255)
  logo        String?       @db.VarChar(255)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relación con usuarios
  userCompanies UserCompany[]

  plans     Plan[] @relation("PlanCompanies") 
  quotations    Quotation[]

  @@map("companies")
}

model UserCompany {
  id        String        @id @default(uuid()) @db.VarChar(36)
  userId    String
  companyId String        @db.VarChar(36)
  createdAt DateTime      @default(now())

  user      User      @relation(fields: [userId], references: [id])
  company   Company   @relation(fields: [companyId], references: [id])

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_companies")
}

// ===============================
// PLANS & VERSIONING
// ===============================

model Plan {
  id          String        @id @default(uuid()) @db.VarChar(36)
  name        String        @db.VarChar(255)
  description String?       @db.Text
  logo        String?       @db.VarChar(255) // ✅ agregado
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  active      Boolean       @default(true)
  companies   Company[] @relation("PlanCompanies")
  createdBy   User    @relation("CreatedPlans", fields: [createdById], references: [id])
  versions    PlanVersion[]

  @@map("plans")
}

// ===============================
// PLAN VERSION (VERSIONADO DE PLANES)
// ===============================

model PlanVersion {
  id           String    @id @default(uuid()) @db.VarChar(36)
  planId       String    @db.VarChar(36)
  version      Int       @default(1)
  isLatest     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  createdById  String
  
  // Restricciones de uso del plan
  desdeMonto   Decimal?  @db.Decimal(12,2)
  hastaMonto   Decimal?  @db.Decimal(12,2)
  desdeCuota   Int?
  hastaCuota   Int?

  // Relaciones
  plan         Plan      @relation(fields: [planId], references: [id])
   
  quotations   Quotation[]
  coefficients PlanCoefficient[]
  createdBy    User      @relation("CreatedPlanVersions", fields: [createdById], references: [id])

  @@map("plan_versions")
  @@unique([planId, version])
}

// ===============================
// COEFICIENTES VERSIONADOS
// ===============================

model PlanCoefficient {
  id             String   @id @default(uuid())
  planVersionId  String   @db.VarChar(36)
  
  // Estructura estándar
  plazo                  Int
  tna                    Decimal @db.Decimal(5,3)
  coeficiente             Decimal @db.Decimal(10,4)
  quebrantoFinanciero     Decimal @db.Decimal(10,4)
  cuotaBalon          Decimal? @db.Decimal(10,2)
  cuotaPromedio       Decimal? @db.Decimal(10,2) 

  planVersion PlanVersion @relation(fields: [planVersionId], references: [id])
  cuotaBalonMonths CuotaBalonMonth[]
}

model CuotaBalonMonth {
  id                 String @id @default(uuid())
  planCoefficientId  String
  month              Int

  planCoefficient PlanCoefficient @relation(fields: [planCoefficientId], references: [id])

  @@map("cuota_balon_months")
}

// ===============================
// COTIZACIONES
// ===============================

model Quotation {
  id              String    @id @default(uuid()) @db.VarChar(36)
  planVersionId   String    @db.VarChar(36)
  companyId       String    @db.VarChar(36)
  userId          String
  clientName      String    @db.VarChar(255)
  clientDni       String    @db.VarChar(20)
  vehicleData     String?   @db.VarChar(255)
  totalValue      Decimal?  @db.Decimal(10, 2)
  createdAt       DateTime  @default(now())

  planVersion PlanVersion @relation(fields: [planVersionId], references: [id])
  company     Company     @relation(fields: [companyId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([planVersionId])
  @@map("quotations")
}
