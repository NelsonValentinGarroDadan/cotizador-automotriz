generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  ADMIN
  USER
}

model User {
  id             Int             @id @default(autoincrement())
  email          String          @unique @db.VarChar(255)
  password       String          @db.VarChar(255)
  firstName      String          @db.VarChar(100)
  lastName       String          @db.VarChar(100)
  role           Role            @default(USER)
  active         Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  // Relación con compañías que el admin creó
  ownedCompanies Company[]       @relation("OwnedCompanies")

  // Relación con compañías donde trabaja (si es empleado)
  companies      UserCompany[]

  // Planes creados por el usuario (normalmente admin)
  createdPlans   Plan[]          @relation("CreatedPlans")

  // Cotizaciones realizadas por el usuario
  quotations     Quotation[]

  @@map("users")
}

model Company {
  id          String        @id @default(uuid()) @db.VarChar(36)
  name        String        @db.VarChar(255)
  logo        String?       @db.VarChar(255)
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Admin dueño de la compañía
  ownerId     Int
  owner       User          @relation("OwnedCompanies", fields: [ownerId], references: [id])

  // Usuarios asociados (empleados)
  userCompanies UserCompany[]

  // Planes de la compañía
  plans         Plan[]
  quotations    Quotation[]
  @@map("companies")
}

// Relación muchos a muchos entre usuarios y compañías (empleados asignados)
model UserCompany {
  id        Int      @id @default(autoincrement())
  userId    Int
  companyId String   @db.VarChar(36)
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_companies")
}

// PLANES creados por el admin de la compañía
model Plan {
  id          String        @id @default(uuid()) @db.VarChar(36)
  name        String        @db.VarChar(255)
  description String?       @db.Text
  companyId   String        @db.VarChar(36)
  createdById Int
  active      Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  company     Company @relation(fields: [companyId], references: [id])
  createdBy   User    @relation("CreatedPlans", fields: [createdById], references: [id])
  versions    PlanVersion[]

  @@map("plans")
}

// HISTORIAL de versiones de un plan
model PlanVersion {
  id           String    @id @default(uuid()) @db.VarChar(36)
  planId       String    @db.VarChar(36)
  version      Int       @default(1)
  coefficients Json      // Coeficientes o parámetros del plan
  createdAt    DateTime  @default(now())

  plan         Plan      @relation(fields: [planId], references: [id])
  quotations   Quotation[]

  @@map("plan_versions")
  @@unique([planId, version])

}

// COTIZACIONES generadas por empleados
model Quotation {
  id              String    @id @default(uuid()) @db.VarChar(36)
  planVersionId   String    @db.VarChar(36)
  companyId       String    @db.VarChar(36)
  userId          Int
  clientName      String    @db.VarChar(255)
  clientDni       String    @db.VarChar(20)
  vehicleData     String?   @db.VarChar(255)
  totalValue      Decimal?  @db.Decimal(10, 2)
  createdAt       DateTime  @default(now())

  planVersion PlanVersion @relation(fields: [planVersionId], references: [id])
  company     Company     @relation(fields: [companyId], references: [id])
  user        User        @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([companyId])
  @@index([planVersionId])
  @@map("quotations")
}
