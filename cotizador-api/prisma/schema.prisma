generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
}

// ===============================
// USERS & COMPANIES
// ===============================

model User {
  id             String        @id @default(uuid()) @db.VarChar(36)
  email          String        @unique @db.VarChar(255)
  password       String        @db.VarChar(255)
  firstName      String        @db.VarChar(100)
  lastName       String        @db.VarChar(100)
  role           Role          @default(USER)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  // Relación con compañías
  companies      UserCompany[]

  // Planes creados
  createdPlans   Plan[]        @relation("CreatedPlans")

  quotations     Quotation[]
 
  createdPlanVersions PlanVersion[] @relation("CreatedPlanVersions")
  allowedPlans        Plan[]        @relation("AllowedPlans")

  @@map("users")
}

model Company {
  id          String        @id @default(uuid()) @db.VarChar(36)
  name        String        @db.VarChar(255)
  logo        String?       @db.VarChar(255)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relación con usuarios
  userCompanies UserCompany[]

  plans      Plan[]        @relation("PlanCompanies")
  quotations Quotation[]
  vehicles   AutosVersion[] @relation("CompanyVehicles")

  @@map("companies")
}

model UserCompany {
  id        String        @id @default(uuid()) @db.VarChar(36)
  userId    String
  companyId String        @db.VarChar(36)
  createdAt DateTime      @default(now())

  user    User    @relation(fields: [userId], references: [id])
  company Company @relation(fields: [companyId], references: [id])

  @@unique([userId, companyId])
  @@index([userId])
  @@index([companyId])
  @@map("user_companies")
}

// ===============================
// PLANS & VERSIONING
// ===============================

model Plan {
  id          String        @id @default(uuid()) @db.VarChar(36)
  name        String        @db.VarChar(255)
  description String?       @db.Text
  logo        String?       @db.VarChar(255)
  createdById String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  active      Boolean       @default(true)

  companies   Company[] @relation("PlanCompanies")
  createdBy   User     @relation("CreatedPlans", fields: [createdById], references: [id])
  versions    PlanVersion[]
  allowedUsers User[]  @relation("AllowedPlans")

  @@map("plans")
}

// ===============================
// PLAN VERSION (VERSIONADO DE PLANES)
// ===============================

model PlanVersion {
  id           String    @id @default(uuid()) @db.VarChar(36)
  planId       String    @db.VarChar(36)
  version      Int       @default(1)
  isLatest     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  createdById  String
  
  // Restricciones de uso del plan
  desdeMonto   Decimal?  @db.Decimal(12, 2)
  hastaMonto   Decimal?  @db.Decimal(12, 2)
  desdeCuota   Int?
  hastaCuota   Int?

  // Relaciones
  plan         Plan      @relation(fields: [planId], references: [id])
   
  quotations   Quotation[]
  coefficients PlanCoefficient[]
  createdBy    User      @relation("CreatedPlanVersions", fields: [createdById], references: [id])

  @@map("plan_versions")
  @@unique([planId, version])
}

// ===============================
// COEFICIENTES VERSIONADOS
// ===============================

model PlanCoefficient {
  id             String   @id @default(uuid())
  planVersionId  String   @db.VarChar(36)
  
  plazo                Int
  tna                  Decimal @db.Decimal(5, 3)
  coeficiente          Decimal @db.Decimal(10, 4)
  quebrantoFinanciero  Decimal @db.Decimal(10, 4)
  cuotaBalon           Decimal? @db.Decimal(10, 2)
  cuotaPromedio        Decimal? @db.Decimal(10, 2) 

  planVersion    PlanVersion      @relation(fields: [planVersionId], references: [id])
  cuotaBalonMonths CuotaBalonMonth[]
}

model CuotaBalonMonth {
  id                 String @id @default(uuid())
  planCoefficientId  String
  month              Int

  planCoefficient PlanCoefficient @relation(fields: [planCoefficientId], references: [id])

  @@map("cuota_balon_months")
}

// ===============================
// COTIZACIONES
// ===============================

model Quotation {
  id               String    @id @default(uuid()) @db.VarChar(36)
  planVersionId    String    @db.VarChar(36)
  companyId        String    @db.VarChar(36)
  userId           String
  clientName       String    @db.VarChar(255)
  clientDni        String    @db.VarChar(20)
  vehicleData      String?   @db.VarChar(255)
  vehicleVersionId Int?
  totalValue       Decimal?  @db.Decimal(10, 2)
  createdAt        DateTime  @default(now())

  planVersion    PlanVersion  @relation(fields: [planVersionId], references: [id])
  company        Company      @relation(fields: [companyId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
  vehicleVersion AutosVersion? @relation(fields: [vehicleVersionId], references: [idversion])

  @@index([userId])
  @@index([companyId])
  @@index([planVersionId])
  @@index([vehicleVersionId])
  @@map("quotations")
}

// ===============================
// AUTOS (CATÁLOGO EXTERNO)
// ===============================

model AutosMarca {
  idmarca        Int            @id
  descrip        String         @db.VarChar(50)
  logo           String         @db.VarChar(100)
  orden          Int
  codigo         String         @db.VarChar(20)
  repuestos      Int
  predeterminada Int

  lineas    AutosLinea[]
  modelos   AutosModelo[]
  versiones AutosVersion[]

  @@map("autos_marcas")
}

model AutosLinea {
  idlinea              Int      @id
  idmarca              Int
  descrip              String   @db.VarChar(50)
  ajuste               Decimal  @db.Decimal(7, 2)
  dias_nadcon          Int
  leyenda_nadcon       String   @db.VarChar(50)
  seguro               Decimal  @db.Decimal(10, 2)
  gestion              Decimal  @db.Decimal(10, 2)
  flete                Decimal  @db.Decimal(10, 2)
  idpais_fabricacion   Int
  compra_vence         Int
  costo_ad_pm          Decimal  @db.Decimal(15, 2)
  costo_ad_pm_costo    Decimal  @db.Decimal(15, 2)
  inactivo             Int
  idgrupo_servicio     Int
  valor_hora_servicio  Decimal  @db.Decimal(10, 2)
  precio_backup        Decimal  @db.Decimal(15, 2)
  valor_dia_chapa      Decimal  @db.Decimal(15, 2)
  valor_panio_pintura  Decimal  @db.Decimal(15, 2)
  adicional_pl_valor   Int
  adicional_pl_porcentaje Int
  precios_en_dolares   Int
  comercial            Int
  cantidad_mo          Int
  costo_entrega        Int
  codigo_salesforce    String   @db.VarChar(30)
  impuesto_interno     Decimal  @db.Decimal(15, 2)
  idtasa               Int
  idiva                Int
  idtipocpu            Int

  marca   AutosMarca  @relation(fields: [idmarca], references: [idmarca])
  modelos AutosModelo[]

  @@map("autos_lineas")
}

model AutosModelo {
  idmodelo                Int      @id
  descrip                 String   @db.VarChar(50)
  idmarca                 Int
  idlinea                 Int
  codigo                  String   @db.VarChar(20)
  codigo_viejo            String   @db.VarChar(10)
  idtipo                  Int
  idmotor                 Int
  idcombustible           Int
  idgrupo                 Int
  iva                     Decimal  @db.Decimal(10, 2)
  idimpuesto              Int
  iibb                    Decimal  @db.Decimal(10, 2)
  costo_ad_pm             Decimal  @db.Decimal(10, 2)
  costo_ad_pvp            Decimal  @db.Decimal(10, 2)
  adicional               Decimal  @db.Decimal(10, 2)
  adicional_pl_valor      Int
  adicional_pl_porcentaje Int

  marca    AutosMarca  @relation(fields: [idmarca], references: [idmarca])
  linea    AutosLinea  @relation(fields: [idlinea], references: [idlinea])
  versiones AutosVersion[]

  @@map("autos_modelos")
}

model AutosVersion {
  idversion              Int      @id
  descrip                String   @db.VarChar(150)
  descrip_nadin          String   @db.VarChar(150)
  descrip_otra           String   @db.VarChar(150)
  idmarca                Int
  idmodelo               Int
  codigo                 String   @db.VarChar(20)
  inactivo               Int
  cod_ph                 String   @db.VarChar(10)
  codigo_viejo           String   @db.VarChar(20)
  codigo_acara           String   @db.VarChar(20)
  nueva_descrip          String   @db.VarChar(100)
  paquetes               String   @db.Text
  paquetes2              String   @db.Text
  paquetes3              String   @db.Text
  ajuste                 Decimal  @db.Decimal(7, 2)
  incentivo_tactico      Int
  incentivo_tactico_ph   Int
  adicional_pl_valor     Int
  adicional_pl_porcentaje Int
  no_tomar_usado         Int
  txt_otro_sistema       String   @db.VarChar(150)
  iibb_cordoba_origen    String   @db.VarChar(10)
  iibb_cordoba_marca     String   @db.VarChar(10)
  iibb_cordoba_tipo      String   @db.VarChar(10)
  iibb_cordoba_modelo    String   @db.VarChar(10)
  iva                    Int
  equipamiento           String   @db.Text
  sfx_ventas             String   @db.VarChar(3)
  sfx_produccion         String   @db.VarChar(3)
  idtasa                 Int
  gear_box_type          String   @db.VarChar(3)
  connected_car          Int
  servicios_conectados   Int
  precio_especial        Int 

  marca     AutosMarca  @relation(fields: [idmarca], references: [idmarca])
  modelo    AutosModelo @relation(fields: [idmodelo], references: [idmodelo])
  company   Company[]    @relation("CompanyVehicles")
  quotations Quotation[]

  @@map("autos_versiones")
}
